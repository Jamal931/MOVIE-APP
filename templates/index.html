<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieVerse</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const Film = () => <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" /></svg>;
        const Search = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
        const Star = ({filled}) => <svg className={`w-5 h-5 ${filled ? 'fill-yellow-400 text-yellow-400' : 'text-gray-400'}`} fill={filled ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>;
        const Calendar = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>;
        const GitCompare = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>;
        const Shuffle = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>;
        const X = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
        const ExternalLink = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>;
        const Loader = () => <svg className="w-8 h-8 text-white animate-spin" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;
        const ChevronLeft = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>;
        const ChevronRight = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>;
        
        const OMDB_API_KEY = '{{ config.OMDB_API_KEY }}';
        const MOVIES_PER_PAGE = 30; // Load 3 pages at once (30 movies)

        function MovieVerse() {
          const [searchQuery, setSearchQuery] = useState('');
          const [allMovies, setAllMovies] = useState([]);
          const [loading, setLoading] = useState(false);
          const [currentPage, setCurrentPage] = useState(1);
          const [totalResults, setTotalResults] = useState(0);
          const [filters, setFilters] = useState({ genre: '', yearStart: '', yearEnd: '' });
          const [expandedMovie, setExpandedMovie] = useState(null);
          const [movieDetails, setMovieDetails] = useState({});
          const [compareMode, setCompareMode] = useState(false);
          const [selectedMovies, setSelectedMovies] = useState([null, null]);
          const [favorites, setFavorites] = useState([]);

          const genres = ['Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Documentary', 
            'Drama', 'Family', 'Fantasy', 'History', 'Horror', 'Music', 'Mystery', 
            'Romance', 'Sci-Fi', 'Sport', 'Thriller', 'War', 'Western'];

          // Load favorites from Flask backend
          useEffect(() => {
            fetch('/api/favorites')
              .then(res => res.json())
              .then(data => setFavorites(data))
              .catch(err => console.error('Error loading favorites:', err));
          }, []);

          // Fetch multiple pages at once to fill the screen
          const fetchMoviesMultiPage = useCallback(async (query, startPage = 1) => {
            if (!query.trim()) {
              setAllMovies([]);
              return;
            }

            setLoading(true);
            try {
              // Fetch 3 pages at once (30 movies)
              const pagePromises = [
                fetch(`/api/movies?query=${encodeURIComponent(query)}&page=${startPage}`),
                fetch(`/api/movies?query=${encodeURIComponent(query)}&page=${startPage + 1}`),
                fetch(`/api/movies?query=${encodeURIComponent(query)}&page=${startPage + 2}`)
              ];

              const responses = await Promise.all(pagePromises);
              const dataPromises = responses.map(res => res.json());
              const allData = await Promise.all(dataPromises);

              // Combine all movies from the 3 pages
              let combinedMovies = [];
              let total = 0;

              allData.forEach(data => {
                if (data.Search) {
                  combinedMovies = [...combinedMovies, ...data.Search];
                  total = parseInt(data.totalResults) || 0;
                }
              });

              setAllMovies(combinedMovies);
              setTotalResults(total);
              
              // Fetch details for all movies to enable genre filtering
              combinedMovies.forEach(movie => {
                if (!movieDetails[movie.imdbID]) {
                  fetchMovieDetails(movie.imdbID);
                }
              });
            } catch (error) {
              console.error('Error fetching movies:', error);
              setAllMovies([]);
            } finally {
              setLoading(false);
            }
          }, [movieDetails]);

          const fetchMovieDetails = async (imdbID) => {
            if (movieDetails[imdbID]) return movieDetails[imdbID];

            try {
              const response = await fetch(`https://www.omdbapi.com/?i=${imdbID}&apikey=${OMDB_API_KEY}`);
              const data = await response.json();
              
              setMovieDetails(prev => ({ ...prev, [imdbID]: data }));
              return data;
            } catch (error) {
              console.error('Error fetching movie details:', error);
              return null;
            }
          };

          const handleSearch = (e) => {
            if (e) e.preventDefault();
            setCurrentPage(1);
            fetchMoviesMultiPage(searchQuery, 1);
          };

          const handleRandomMovie = async () => {
            const keywords = ['love', 'man', 'star', 'war', 'hero', 'dark', 'life', 'night', 'king', 'girl'];
            const randomKeyword = keywords[Math.floor(Math.random() * keywords.length)];
            const randomPage = Math.ceil(Math.random() * 10);
            
            setLoading(true);
            try {
              const response = await fetch(`/api/movies?query=${randomKeyword}&page=${randomPage}`);
              const data = await response.json();
              
              if (data.Search && data.Search.length > 0) {
                const randomMovie = data.Search[Math.floor(Math.random() * data.Search.length)];
                setAllMovies([randomMovie]);
                setTotalResults(1);
                setExpandedMovie(randomMovie.imdbID);
                await fetchMovieDetails(randomMovie.imdbID);
              }
            } catch (error) {
              console.error('Error fetching random movie:', error);
            } finally {
              setLoading(false);
            }
          };

          const handlePrevPage = () => {
            const newPage = Math.max(1, currentPage - 1);
            setCurrentPage(newPage);
            fetchMoviesMultiPage(searchQuery, (newPage - 1) * 3 + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };

          const handleNextPage = () => {
            const newPage = currentPage + 1;
            setCurrentPage(newPage);
            fetchMoviesMultiPage(searchQuery, (newPage - 1) * 3 + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };

          const toggleMovieDetails = async (imdbID) => {
            if (expandedMovie === imdbID) {
              setExpandedMovie(null);
            } else {
              setExpandedMovie(imdbID);
              await fetchMovieDetails(imdbID);
            }
          };

          const addToCompare = (movie) => {
            if (selectedMovies[0] === null) {
              setSelectedMovies([movie, selectedMovies[1]]);
            } else if (selectedMovies[1] === null) {
              setSelectedMovies([selectedMovies[0], movie]);
            } else {
              setSelectedMovies([movie, selectedMovies[1]]);
            }
            setCompareMode(true);
          };

          const removeFromCompare = (index) => {
            const newSelected = [...selectedMovies];
            newSelected[index] = null;
            setSelectedMovies(newSelected);
          };

          const toggleFavorite = async (movie) => {
            const isFav = favorites.some(fav => fav.imdbID === movie.imdbID);
            
            try {
              if (isFav) {
                await fetch('/api/favorites', {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ movie })
                });
                setFavorites(prev => prev.filter(fav => fav.imdbID !== movie.imdbID));
              } else {
                await fetch('/api/favorites', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ movie })
                });
                setFavorites(prev => [...prev, movie]);
              }
            } catch (error) {
              console.error('Error updating favorites:', error);
            }
          };

          const isFavorite = (imdbID) => favorites.some(fav => fav.imdbID === imdbID);

          const filteredMovies = allMovies.filter(movie => {
            // Genre filtering - check movie details if loaded
            const details = movieDetails[movie.imdbID];
            if (filters.genre) {
              if (!details) return true; // Keep showing while loading details
              if (!details.Genre?.includes(filters.genre)) return false;
            }
            
            // Year filtering - extract first 4 digits from year string
            const movieYear = parseInt(movie.Year.match(/\d{4}/)?.[0] || movie.Year);
            if (filters.yearStart && movieYear < parseInt(filters.yearStart)) return false;
            if (filters.yearEnd && movieYear > parseInt(filters.yearEnd)) return false;
            return true;
          });

          const totalPages = Math.ceil(totalResults / MOVIES_PER_PAGE);

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-purple-700 p-4 md:p-8">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-6 mb-6">
                  <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                      <Film />
                      <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        MovieVerse
                      </h1>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setCompareMode(!compareMode)}
                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-2"
                      >
                        <GitCompare />
                        <span className="hidden md:inline">Compare</span>
                      </button>
                      <button
                        onClick={handleRandomMovie}
                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2"
                      >
                        <Shuffle />
                        <span className="hidden md:inline">Random</span>
                      </button>
                    </div>
                  </div>

                  <div className="mb-4">
                    <div className="flex gap-2">
                      <div className="flex-1 relative">
                        <span className="absolute left-3 top-1/2 transform -translate-y-1/2"><Search /></span>
                        <input
                          type="text"
                          value={searchQuery}
                          onChange={(e) => setSearchQuery(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                          placeholder="Search for movies..."
                          className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                      <button
                        onClick={handleSearch}
                        className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
                      >
                        Search
                      </button>
                    </div>
                  </div>

                  <div className="flex flex-wrap gap-3">
                    <select
                      value={filters.genre}
                      onChange={(e) => setFilters({ ...filters, genre: e.target.value })}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">All Genres</option>
                      {genres.map(genre => (
                        <option key={genre} value={genre}>{genre}</option>
                      ))}
                    </select>
                    <input
                      type="number"
                      value={filters.yearStart}
                      onChange={(e) => setFilters({ ...filters, yearStart: e.target.value })}
                      placeholder="Year Start"
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-32"
                    />
                    <input
                      type="number"
                      value={filters.yearEnd}
                      onChange={(e) => setFilters({ ...filters, yearEnd: e.target.value })}
                      placeholder="Year End"
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-32"
                    />
                    <button
                      onClick={() => setFilters({ genre: '', yearStart: '', yearEnd: '' })}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition flex items-center gap-2"
                    >
                      <X />
                      Clear
                    </button>
                  </div>
                </div>

                {compareMode && (
                  <div className="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-6 mb-6">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                      <GitCompare />
                      Compare Movies
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {selectedMovies.map((movie, index) => (
                        <div key={index} className="border-2 border-dashed border-gray-300 rounded-lg p-4 min-h-[200px]">
                          {movie ? (
                            <div className="relative">
                              <button
                                onClick={() => removeFromCompare(index)}
                                className="absolute top-0 right-0 p-1 bg-red-500 text-white rounded-full hover:bg-red-600"
                              >
                                <X />
                              </button>
                              <img src={movie.Poster} alt={movie.Title} className="w-full h-48 object-cover rounded-lg mb-3" />
                              <h3 className="font-bold text-lg mb-1">{movie.Title}</h3>
                              <p className="text-gray-600">{movie.Year}</p>
                              <p className="text-gray-500 text-sm">{movie.Type}</p>
                            </div>
                          ) : (
                            <div className="flex items-center justify-center h-full text-gray-400">
                              <div className="text-center">
                                <Film />
                                <p>Select Movie {index + 1}</p>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {loading && (
                  <div className="flex justify-center items-center py-12">
                    <Loader />
                  </div>
                )}

                {!loading && filteredMovies.length > 0 && (
                  <>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-6">
                      {filteredMovies.map((movie) => (
                        <div key={movie.imdbID} className="bg-white rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition-transform">
                          <div className="relative">
                            <img 
                              src={movie.Poster !== 'N/A' ? movie.Poster : 'https://via.placeholder.com/300x450?text=No+Poster'} 
                              alt={movie.Title}
                              className="w-full h-64 object-cover"
                            />
                            <button
                              onClick={() => toggleFavorite(movie)}
                              className="absolute top-2 right-2 p-2 bg-white/90 rounded-full hover:bg-white transition"
                            >
                              <Star filled={isFavorite(movie.imdbID)} />
                            </button>
                          </div>
                          
                          <div className="p-3">
                            <h3 className="font-bold text-sm mb-2 line-clamp-2 h-10">{movie.Title}</h3>
                            <div className="flex items-center gap-1 text-gray-600 mb-2 text-xs">
                              <Calendar />
                              <span>{movie.Year}</span>
                            </div>

                            <div className="flex gap-1">
                              <button
                                onClick={() => toggleMovieDetails(movie.imdbID)}
                                className="flex-1 px-2 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-xs"
                              >
                                {expandedMovie === movie.imdbID ? 'Hide' : 'Details'}
                              </button>
                              <button
                                onClick={() => addToCompare(movie)}
                                className="px-2 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                              >
                                <GitCompare />
                              </button>
                              <a
                                href={`https://www.imdb.com/title/${movie.imdbID}/`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="px-2 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                              >
                                <ExternalLink />
                              </a>
                            </div>

                            {expandedMovie === movie.imdbID && movieDetails[movie.imdbID] && (
                              <div className="mt-3 pt-3 border-t border-gray-200 space-y-1 text-xs">
                                <p><strong>Rated:</strong> {movieDetails[movie.imdbID].Rated}</p>
                                <p><strong>Runtime:</strong> {movieDetails[movie.imdbID].Runtime}</p>
                                <p><strong>Genre:</strong> {movieDetails[movie.imdbID].Genre}</p>
                                <p><strong>Director:</strong> {movieDetails[movie.imdbID].Director}</p>
                                <p className="line-clamp-2"><strong>Plot:</strong> {movieDetails[movie.imdbID].Plot}</p>
                                {movieDetails[movie.imdbID].imdbRating && (
                                  <p><strong>IMDb:</strong> ‚≠ê {movieDetails[movie.imdbID].imdbRating}/10</p>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>

                    {/* Pagination */}
                    <div className="flex justify-center items-center gap-4 bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-6">
                      <button
                        onClick={handlePrevPage}
                        disabled={currentPage === 1}
                        className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400 font-medium"
                      >
                        <ChevronLeft />
                        Previous
                      </button>
                      
                      <div className="text-center">
                        <p className="text-xl font-bold text-gray-800">Page {currentPage} of {totalPages}</p>
                        <p className="text-sm text-gray-600">Showing {filteredMovies.length} movies</p>
                      </div>

                      <button
                        onClick={handleNextPage}
                        disabled={currentPage >= totalPages}
                        className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400 font-medium"
                      >
                        Next
                        <ChevronRight />
                      </button>
                    </div>
                  </>
                )}

                {!loading && searchQuery && filteredMovies.length === 0 && (
                  <div className="bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-12 text-center">
                    <Film />
                    <h3 className="text-xl font-bold text-gray-700 mb-2">No movies found</h3>
                    <p className="text-gray-500">Try adjusting your search or filters</p>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<MovieVerse />, document.getElementById('root'));
    </script>
</body>
</html>